<!DOCTYPE HTML>
<!--
Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
-->

<!--
  Copyright 2009 Google Inc. All Rights Reserved.


-->
<html>
<head>
<title>Closure Unit Tests - goog.positioning.AnchoredViewportPosition</title>
<script src="../base.js"></script>
<script>
goog.require('goog.dom');
goog.require('goog.positioning.AnchoredViewportPosition');
goog.require('goog.style');
goog.require('goog.testing.jsunit');
</script>
</head>
<body>
<!-- Use IFRAME to avoid non-deterministic window size problems in Selenium. -->
<iframe id="frame1" style="width:200px; height:200px;"
        src="anchoredviewportposition_test_iframe.html">
</iframe>
<script>
var frame, doc, dom, viewportSize, anchor, popup;
var corner = goog.positioning.Corner;

function setUp() {
  frame = document.getElementById('frame1');
  doc = goog.dom.getFrameContentDocument(frame);
  dom = goog.dom.getDomHelper(doc);
  viewportSize = dom.getViewportSize();
  anchor = dom.$('anchor');
  popup = dom.$('popup');
  goog.style.setSize(popup, 20, 20);
}

function assertGreaterThanOrEqual(a, b) {
  assertTrue(a >= b);
}

function assertGreaterThan(a, b) {
  assertTrue(a > b);
}

// The frame has enough space at the bottom of the anchor.
function testRepositionBottom() {
  var avp = new goog.positioning.AnchoredViewportPosition(
      anchor, corner.BOTTOM_LEFT, false);
  goog.style.setSize(anchor, 100, 100);
  goog.style.setPosition(anchor, 0, 0);
  assertGreaterThanOrEqual(viewportSize.height, 100 + 20);

  avp.reposition(popup, corner.TOP_LEFT);
  var anchorRect = goog.style.getBounds(anchor);
  assertEquals(anchorRect.top + anchorRect.height,
               goog.style.getPageOffset(popup).y);
}

// No enough space at the bottom, but at the top.
function testRepositionTop() {
  var avp = new goog.positioning.AnchoredViewportPosition(
      anchor, corner.BOTTOM_LEFT, false);
  var newTop = viewportSize.height - 100;
  goog.style.setSize(anchor, 100, 100);
  goog.style.setPosition(anchor, 50, newTop);
  assertGreaterThanOrEqual(newTop, 20);

  avp.reposition(popup, corner.TOP_LEFT);
  anchorRect = goog.style.getBounds(anchor);
  var popupRect = goog.style.getBounds(popup);
  assertEquals(anchorRect.top, popupRect.top + popupRect.height);
}

// Enough space at neither the bottom nor the top.  Adjustment flag is false.
function testRepositionNoSpaceWithoutAdjustment() {
  var avp = new goog.positioning.AnchoredViewportPosition(
      anchor, corner.BOTTOM_LEFT, false);
  goog.style.setPosition(anchor, 50, 10);
  goog.style.setSize(anchor, 100, viewportSize.height - 20);

  avp.reposition(popup, corner.TOP_LEFT);
  anchorRect = goog.style.getBounds(anchor);
  popupRect = goog.style.getBounds(popup);
  assertEquals(anchorRect.top + anchorRect.height, popupRect.top);
  assertGreaterThan(popupRect.top + popupRect.height, viewportSize.height);
}

// Enough space at neither the bottom nor the top.  Adjustment flag is true.
function testRepositionNoSpaceWithAdjustment() {
  var avp = new goog.positioning.AnchoredViewportPosition(
      anchor, corner.BOTTOM_LEFT, true);
  goog.style.setPosition(anchor, 50, 10);
  goog.style.setSize(anchor, 100, viewportSize.height - 20);

  avp.reposition(popup, corner.TOP_LEFT);
  anchorRect = goog.style.getBounds(anchor);
  popupRect = goog.style.getBounds(popup);
  assertGreaterThan(anchorRect.top + anchorRect.height, popupRect.top);
  assertEquals(viewportSize.height, popupRect.top + popupRect.height);
}

</script>
</body>
</html>
